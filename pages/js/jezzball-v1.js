(()=>{"use strict";let t;function e(i,h){void 0===t&&(t=Date.now());let s=Math.min((Date.now()-t)/(1e3/60),2);t=Date.now();const n=window.getComputedStyle(i).getPropertyValue("opacity");if(n<=0)return void h();let l=window.getComputedStyle(i).getPropertyValue("height");l=Number(l.substring(0,l.length-2));i.setAttribute("style",`opacity: ${n-.1*s}; height: ${l-.25*l*s}px`),requestAnimationFrame((()=>e(i,h)))}const i=function(t,i,h){fetch("/token/submit",{method:"POST",credentials:"same-origin",body:JSON.stringify({filename:t,score:i}),cache:"no-cache",headers:new Headers({"content-type":"application/json","X-CSRFToken":h})}).then((t=>t.ok?t.json():null)).then((t=>{if(!t)return;const i=document.getElementById("score-alert-area"),h=document.createElement("span"),s=document.getElementById("arcade_tokens"),n=Number(s.innerText),l=n+t.payout;let o;h.setAttribute("class","p-2 text-center alert alert-warning cart-alert"),h.setAttribute("data-timestamp",Date.now()),t.payout<1?(h.setAttribute("class","p-2 text-center alert alert-warning cart-alert"),o="Score too low"):(h.setAttribute("class","p-2 text-center alert alert-success cart-alert"),o=`Got ${t.payout} token`),t.payout>1&&(o+="s"),h.innerText=o,i.appendChild(h);if(setTimeout((()=>{requestAnimationFrame((()=>e(h,(()=>{i.removeChild(h)}))))}),3e3),!(t.payout<1)){if(s.innerText=l,1==l||1==n){const t=document.getElementById("arcade_tokens_word");t.innerText=1==l?t.innerText.substring(0,t.innerText.length-1):t.innerText+"s"}s.parentElement.classList.remove("d-none")}}))};const h=function(){const t=document.getElementById("send_score_button");if(!t)return;t.setAttribute("style","display: none;");const e=t.cloneNode(!0);t.parentNode.replaceChild(e,t)},s=[];class n{static speed=4;static radius=12;static sq_radius=Math.pow(12,2);static colours=["purple","blue","green","#f4a32e","#ff4c00","#9a0200","#da482e","#0a827c","#043836","black"];constructor(t,e,i){this.i=t,this.x=e,this.y=i,this.dx=n.speed,this.dy=-n.speed,this.colour=n.colours[t]}collideWithBall(t,e){return n.sq_radius>Math.pow(this.x-t,2)+Math.pow(this.y-e,2)}draw(t,e){q.beginPath(),q.arc(this.x,this.y,n.radius,0,2*Math.PI),q.fillStyle=this.colour,q.fill(),q.closePath()}move(t){if(tt.ballPause>0)return void tt.ballPause--;const e=()=>this.x+this.dx*H(t),i=()=>this.y+this.dy*H(t);let h=e(),l=i(),o=!1;if((h>Y.width-n.radius||h<n.radius)&&(o=!0,this.dx=n.bounce(this.dx),h=e()),(l<n.radius||l>Y.height-n.radius)&&(o=!0,this.dy=n.bounce(this.dy),l=i()),this.x=h,this.y=l,!o)for(let t of s)t.i!=this.i&&this.collideWithBall(t.x,t.y)&&(o=!0,Math.random()>.5?this.dx=n.bounce(this.dx):this.dy=n.bounce(this.dy));return o=o?-1:this.collideWithWalls(t),o}static bounce(t){return t=-t,n.speed-Math.abs(t)>.7&&(t=t<0?-n.speed:n.speed),t<0?t+=Math.random()/4:t-=Math.random()/4,t}intersectsX(t,e){let i=c(this.y-n.radius);return t+n.radius>e.x&&t-n.radius<e.x+e.width&&e.y+e.height>i-n.radius&&e.y<i+n.radius&&t<Y.width-n.radius&&t>n.radius}intersectsY(t,e){let i=c(this.x-n.radius);return t+n.radius>e.y&&t-n.radius<e.y+e.height&&e.x+e.width>i-n.radius&&e.x<i+n.radius&&t>n.radius&&t<Y.height-n.radius}collideWithWalls(t){let e,i=!1;for(let h=0;h<w.length;h++)if(0==w[h].dir?(e=this.dx<0?c(this.x):c(this.x+n.radius),this.intersectsX(e,w[h])&&(i=!0,this.intersectsX(e+n.bounce(this.dx)*H(t),w[h])&&(this.x=this.dx>0?e-r:e+r),this.dx=n.bounce(this.dx))):(e=this.dy<0?c(this.y):c(this.y+n.radius),this.intersectsY(e,w[h])&&(i=!0,this.intersectsY(e+n.bounce(this.dy)*H(t),w[h])&&(this.y=this.dy>0?e-r:e+r),this.dy=n.bounce(this.dy))),i)return null===w[h].building?h:-1}}let l=document.getElementById("game"),o=document.createElement("canvas");o.width=l.offsetWidth,o.height=l.offsetHeight,o.setAttribute("id","slow-layer"),l.appendChild(o);const r=12,d=t=>Math.floor(t/r),a=t=>t*r,c=t=>a(d(t)),u=t=>Array.apply(null,Array(t)),f=t=>u(d(o.height)).map((()=>u(d(o.width)).map((()=>t))));let g;class y{constructor(t,e,i,h){this.x=t,this.y=e,this.width=i,this.height=h,this.drawn=!1}draw(){if(!this.drawn){if(1==d(this.width))for(let t=d(this.y);t<d(this.height+this.y);t++)J.fill_cell(d(this.x),t);else if(1==d(this.height))for(let t=d(this.x);t<d(this.width+this.x);t++)J.fill_cell(t,d(this.y));else console.error("Wall size isn't divisible into the grid??");J.flood_fill(),J.draw(),this.drawn=!0,z=Math.round(J.percentFilled()),z>75&&(j+=z-75,function(){j+=5,z=0,ht.ballCount+=1,it(),et(),J.clear();for(let t=2;t<ht.ballCount;t++)s[s.length]=new n(s.length),s[s.length-1].x=Y.width*(Math.min(.8,Math.random())+.1),s[s.length-1].y=Y.height*(Math.min(.8,Math.random())+.1),Math.random()>.5?s[s.length-1].dx=-n.speed:s[s.length-1].dx=n.speed,Math.random()>.5?s[s.length-1].dy=-n.speed:s[s.length-1].dy=n.speed}()),x.count-=1}}}const w=[];function p(){!1===V&&!1===K&&0==x.count&&!1===tt.active&&w.push(new x)}class x{static count=0;static remove(t){w.splice(t,1),x.count-=1}constructor(){if(x.count+=1,this._x=c(Z.x),this._y=c(Z.y),this.dir=Z.direction,this._width=Z.width,this._height=Z.height,this.building=null,this.lowpoint=0,this.highpoint=0==this.dir?Y.height:Y.width,0==this.dir){let t=d(this.x);for(let e=d(this.y);e<=d(this.height+this.y)&&e<d(Y.height);e++)if(!0===J.get_cell(t,e)){if(e>d(this.y)){this._y-=r*(2*(e-d(this.y)));break}if(e==d(this.y)){this._y+=r;break}}}else{let t=d(this.y);for(let e=d(this.x);e<=d(this.width+this.x)&&e<d(Y.width);e++)if(!0===J.get_cell(e,t)){if(e>d(this.x)){this._x-=r*(2*(e-d(this.x)));break}if(e==d(this.x)){this._x+=r;break}}}for(let t of w)0==this.dir&&1==t.dir&&t.x+t.width>this.x&&t.x<this.x+this.width?t.y+t.height>this.lowpoint&&t.y+t.height<this.y+this.height?this.lowpoint=t.y+t.height:t.y<this.highpoint&&t.y>this.y+this.height&&(this.highpoint=t.y):1==this.dir&&0==t.dir&&t.y+t.height>this.y&&t.y<this.y+this.height&&(t.x+t.width>this.lowpoint&&t.x<this.x?this.lowpoint=t.x+t.width:t.x<this.highpoint&&t.x>this.x+this.width&&(this.highpoint=t.x));this.highpoint=c(this.highpoint),this.lowpoint=c(this.lowpoint)}expand(t){if(null!==this.building)throw"This wall finished expanding";0==this.dir?Math.abs(this.height-(this.highpoint-this.lowpoint))<=r+1?(this.height=this.highpoint-this.lowpoint,this.y=this.lowpoint,this.building=new y(this.x,this.y,this.width,this.height)):this.y>this.lowpoint&&this.y+this.height<this.highpoint?(this.height+=20*H(t),this.y-=10*H(t)):this.y>this.lowpoint?(this.y-=10*H(t),this.height+=10*H(t)):(this.y=this.lowpoint.valueOf(),this.height+=10*H(t)):Math.abs(this.width-(this.highpoint-this.lowpoint))<=r+1?(this.width=this.highpoint-this.lowpoint,this.x=this.lowpoint,this.building=new y(this.x,this.y,this.width,this.height)):this.x>this.lowpoint&&this.x+this.width<this.highpoint?(this.width+=20*H(t),this.x-=10*H(t)):this.x>this.lowpoint?(this.x-=10*H(t),this.width+=10*H(t)):(this.x=this.lowpoint.valueOf(),this.width+=10*H(t))}draw(){this.building?this.building.draw():(q.fillStyle="black",q.fillRect(Math.floor(this.x),Math.floor(this.y),this.width,this.height))}get x(){return this.building?this.building.x:this._x}get y(){return this.building?this.building.y:this._y}set x(t){this._x=t}set y(t){this._y=t}set width(t){this._width=t}set height(t){this._height=t}get width(){return this.building?this.building.width:this._width}get height(){return this.building?this.building.height:this._height}}let m=document.getElementById("game"),b=document.createElement("canvas");b.width=m.offsetWidth,b.height=m.offsetHeight,b.setAttribute("id","ui-layer"),m.appendChild(b);let v=b.getContext("2d"),_=0,T=0,E=-1,k=-1,C=-1,M=!1,L="#000";const A="2.0rem 'Atkinson Hyperlegible Next'",S="3.6rem 'Atkinson Hyperlegible Next'";function P(t){R(t),t.preventDefault()}function B(t){1==V&&0==K?st():p(),t.preventDefault()}function R(t){let e=t.changedTouches[0];_=e.pageX-m.offsetLeft,T=e.pageY-m.offsetTop,_>0&&_<b.width&&(Z.x=_<=r?0:_-Z.width/2),T>0&&T<b.height&&(Z.y=T<=r?0:T-Z.height/2),t.preventDefault()}function D(t){let e=document.getScroll();_=t.clientX-m.offsetLeft+e[0],T=t.clientY-m.offsetTop+e[1],_>0&&_<b.width&&(Z.x=_<=r?0:_-Z.width/2),T>0&&T<b.height&&(Z.y=T<=r?0:T-Z.height/2)}function I(t){0==t.button?1==V&&0==K?st():p():t.button>0&&lt()}function W(t){39==t.keyCode||37==t.keyCode?Z.direction=1:38==t.keyCode||40==t.keyCode?Z.direction=0:32==t.keyCode&&1==V&&0==K?st():80==t.keyCode&&ot(),t.preventDefault()}function $(t=!1){1!=V?((t||tt.diedRecently>0||C!=z||k!=j||E!=G||1==tt.active)&&(O(),F(),function(){v.font=A,tt.diedRecently>0&&(tt.diedRecently%15==0&&"#000"==L?L="#ff0000":(tt.diedRecently%15==0&&"#ff0000"==L||1==tt.diedRecently)&&(L="#000"),tt.diedRecently--);let t;v.fillStyle=L,t=-1==G?"0":G.toString();t=`Lives: ${t}`;const e=v.measureText(t).width;v.fillText(t,b.width-e-r,2*r)}(),C=z,k=j,E=G),tt.ballPause>0?function(){let t=Math.floor(tt.ballPause/60)+1;v.font=S,v.fillStyle=N,t%2==0&&(v.fillStyle="black");v.fillText("JEZZBALL",b.width/2-v.measureText("JEZZBALL").width/2,b.height/2-7*r),v.fillText(t,b.width/2-v.measureText(t).width/2,b.height/2+r)}():0==tt.ballPause&&1==tt.active&&(tt.active=!1)):0==M&&(O(),function(){const t="Game Over",e="tap or click to restart";v.font=S,v.fillStyle="#33aaff",v.fillText(t,b.width/2-v.measureText(t).width/2,b.height/2-3*r),v.font=A,v.fillText(e,b.width/2-v.measureText(e).width/2,b.height/2+2*r)}(),F(),M=!0)}function O(){M=!1,v.clearRect(0,0,b.width,b.height)}function F(){v.font=A,v.fillStyle="#000",v.fillText(`${z}% Cleared`,r,2*r);const t=`Score: ${j}`;v.fillText(t,r*(d(b.width)/2)-v.measureText(t).width/2,b.height-r)}document.getScroll=function(){if(null!=window.pageYOffset)return[pageXOffset,pageYOffset];{let t,e,i=document,h=i.documentElement,s=i.body;return t=h.scrollLeft||s.scrollLeft||0,e=h.scrollTop||s.scrollTop||0,[t,e]}};const N="#993f70";let X=document.getElementById("game");const Y=document.createElement("canvas");Y.setAttribute("id","game-layer"),window.addEventListener("load",(()=>{Y.width=X.offsetWidth,Y.height=X.offsetHeight,X.appendChild(Y)}));const q=Y.getContext("2d",{alpha:!1}),H=t=>Math.min(t/(1e3/60),2),Z=new class{constructor(){this.colour=N,this.x=Y.width/2,this.y=Y.height/2,this.direction=0}get x(){return this._x}set x(t){this._x=c(t)}get y(){return this._y}set y(t){this._y=c(t)}get direction(){return this._dir}set direction(t){0==t?(this.height=2*r,this.width=r):(this.height=r,this.width=2*r),this.x=_-this.width/2,this.y=T-this.height/2,this._dir=t}draw(){q.fillStyle=this.colour,q.fillRect(this.x,this.y,this.width,this.height)}},J=new class{constructor(){this.ctx=o.getContext("2d"),this.ctx.fillStyle=N;this.grid=f(!1),g=d(o.width)*d(o.height)}draw(){for(let t=0;t<this.grid.length;t++){let e=0;for(let i of this.grid[t])e++,i&&this.draw_cell(a(e),a(t))}}draw_cell(t,e){this.ctx.fillRect(t-r,e,r,r)}fill_cell(t,e){try{this.grid[e][t]=!0}catch(i){throw i instanceof TypeError&&console.error(`(x${t}, y${e}) is out of bounds`),i}}get_cell(t,e){try{return this.grid[e][t]}catch(i){throw i instanceof TypeError&&console.error(`(x${t}, y${e}) is out of bounds`),i}}clear(){for(let t=0;t<this.grid.length;t++)for(let e=0;e<d(o.width);e++)this.grid[t][e]=!1;this.ctx.clearRect(0,0,o.width,o.height)}recursive_fill(t,e,i){return e>=0&&e<d(o.width)&&i>=0&&i<d(o.height)&&!1===this.grid[i][e]&&!0===t[i][e]&&(t[i][e]=!1,t=this.recursive_fill(t,e-1,i),t=this.recursive_fill(t,e+1,i),t=this.recursive_fill(t,e,i-1),t=this.recursive_fill(t,e,i+1)),t}flood_fill(){let t=f(!0);for(let e of s){let i=d(e.x-n.radius),h=d(e.y-n.radius);t=this.recursive_fill(t,i,h)}for(let e=0;e<this.grid.length;e++)for(let i=0;i<d(o.width);i++)this.grid[e][i]=t[e][i]}percentFilled(){let t=0,e=this.grid.map((t=>t.filter((t=>{if(!0===t)return t}))));for(let i=0;i<e.length;i++)t+=e[i].length;return t/g*100}};let j=0,z=0,G=3,V=!1,K=!1,Q=Date.now();const U=function(t){return()=>{const e=document.getElementById("send_score_button");if(e){function h(s){i(document.getElementById("game_title").dataset.filename,t,e.dataset.csrfToken),s.currentTarget.setAttribute("style","display: none;"),s.currentTarget.removeEventListener("click",h),s.stopPropagation()}e.setAttribute("style","z-index: 100; display: block; left: 50%; bottom: 30%; transform: translate(-50%);"),e.addEventListener("click",h)}}}(j);let tt={active:!1,ballPause:0,diedRecently:0,dying:0};function et(){for(;w.length>0;)w.pop()}function it(){for(;s.length>2;)s.pop();tt.ballPause=180,tt.active=!0,tt.dying=0}let ht={ballCount:2};function st(){null!=h&&h(),s[0].x=Y.width/2-48,s[0].y=Y.height-96,s[1].x=Y.width/2+48,s[1].y=Y.height-96,s[0].dy=-n.speed,s[0].dx=-n.speed,s[1].dy=n.speed,s[1].dx=n.speed,ht.ballCount=2,z=0,j=0,G=3,V=!1,J.clear(),et(),it(),nt()}function nt(){let t=Date.now()-Q;if(q.fillStyle="#ffffff",q.fillRect(0,0,Y.width,Y.height),1==K)return v.font=S,v.fillStyle="#333",v.fillText("Paused",b.width/2-v.measureText("Paused").width/2,b.height/2),void requestAnimationFrame(nt);for(let e of w.filter((t=>{if(null===t.building)return t})))e.expand(t);for(let e=0;e<s.length;e++){let i=s[e].move(t);i>-1&&(0==tt.dying&&(tt.dying=30,G>0&&(tt.diedRecently=90),G--),x.remove(i))}if(tt.dying>0&&(tt.dying--,0==tt.dying&&G<0&&(U(),V=!0)),$(),!V){for(let t=0;t<w.length;t++)w[t].draw();for(let t=0;t<s.length;t++)s[t].draw();Z.draw(),requestAnimationFrame(nt),Q=Date.now()}}function lt(){0==Z.direction?Z.direction=1:Z.direction=0}function ot(){1==K?(K=!1,O(),$(!0)):K=!0}s[0]=new n(0),s[1]=new n(1),lt(),document.getElementById("pause_button").addEventListener("click",ot,!1),document.getElementById("swap_button").addEventListener("click",lt,!1),b.addEventListener("touchstart",P,{passive:!1,capture:!1}),b.addEventListener("touchend",B,!1),b.addEventListener("touchmove",R,{passive:!1,capture:!1}),b.addEventListener("mousedown",I,!1),b.addEventListener("mousemove",D,!1),document.addEventListener("contextmenu",(function(t){m.contains(t.target)&&t.preventDefault()}),!1),document.addEventListener("keyup",W,!1),st()})();